services:
  postgres:
    image: postgres:16-alpine
    env_file: .env
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 90s
    restart: unless-stopped
    networks:
      - kubememory-net

  redis:
    image: redis:7-alpine
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - kubememory-net

  django-api:
    build: ./backend
    env_file: .env
    environment:
      DJANGO_SETTINGS_MODULE: config.settings.dev
      POSTGRES_HOST: postgres
      REDIS_URL: redis://redis:6379/0
      CELERY_BROKER_URL: redis://redis:6379/1
      CELERY_RESULT_BACKEND: redis://redis:6379/2
      CHANNEL_LAYERS_HOST: redis
      CHANNEL_LAYERS_PORT: 6379
      K8S_KUBECONFIG_PATH: /app/.kube/config
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      neo4j:
        condition: service_healthy
    volumes:
      - chroma_data:/app/chroma_data
      - ./kubeconfig:/app/.kube/config:ro
    ports:
      - "8000:8000"
    command: python -m daphne -b 0.0.0.0 -p 8000 config.asgi:application
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/admin/')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - kubememory-net

  celery-worker:
    build: ./backend
    env_file: .env
    environment:
      DJANGO_SETTINGS_MODULE: config.settings.dev
      POSTGRES_HOST: postgres
      CELERY_BROKER_URL: redis://redis:6379/1
      CELERY_RESULT_BACKEND: redis://redis:6379/2
      CHANNEL_LAYERS_HOST: redis
      CHANNEL_LAYERS_PORT: 6379
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      django-api:
        condition: service_started
    volumes:
      - chroma_data:/app/chroma_data
    command: python -m celery -A config worker -l info
    healthcheck:
      test: ["CMD", "python", "-m", "celery", "-A", "config", "inspect", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - kubememory-net

  celery-beat:
    build: ./backend
    env_file: .env
    environment:
      DJANGO_SETTINGS_MODULE: config.settings.dev
      POSTGRES_HOST: postgres
      CELERY_BROKER_URL: redis://redis:6379/1
      CELERY_RESULT_BACKEND: redis://redis:6379/2
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      django-api:
        condition: service_started
    command: python -m celery -A config beat -l info
    healthcheck:
      disable: true
    restart: unless-stopped
    networks:
      - kubememory-net

  neo4j:
    image: neo4j:5-community
    environment:
      NEO4J_AUTH: ${NEO4J_USER}/${NEO4J_PASSWORD}
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - neo4j_data:/data
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:7474"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s
    restart: unless-stopped
    networks:
      - kubememory-net

  ollama:
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    restart: unless-stopped
    networks:
      - kubememory-net

  ollama-init:
    image: ollama/ollama:latest
    depends_on:
      ollama:
        condition: service_started
    environment:
      OLLAMA_HOST: http://ollama:11434
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "sleep 20 &&
       ollama pull qwen2.5:0.5b &&
       ollama pull nomic-embed-text &&
       ollama pull mistral:7b &&
       echo 'Models ready'"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - kubememory-net

  frontend:
    build: ./frontend
    ports:
      - "5173:80"
    depends_on:
      - django-api
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:80"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    networks:
      - kubememory-net

volumes:
  postgres_data:
  neo4j_data:
  ollama_data:
  chroma_data:

networks:
  kubememory-net:
    driver: bridge
